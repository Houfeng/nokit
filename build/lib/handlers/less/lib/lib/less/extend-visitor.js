/*csd*/(function(a){a.extendFinderVisitor=function(){this._visitor=new a.visitor(this);this.contexts=[];this.allExtendsStack=[[]];};a.extendFinderVisitor.prototype={run:function(b){b=this._visitor.visit(b);b.allExtends=this.allExtendsStack[0];return b;},visitRule:function(b,c){c.visitDeeper=false;},visitMixinDefinition:function(b,c){c.visitDeeper=false;},visitRuleset:function(l,p){if(l.root){return;}var e,f,c,b=[],d;var k=l.rules,h=k?k.length:0;for(e=0;e<h;e++){if(l.rules[e] instanceof a.Extend){b.push(k[e]);l.extendOnEveryPath=true;}}var g=l.paths;for(e=0;e<g.length;e++){var n=g[e],m=n[n.length-1],o=m.extendList;d=o?o.slice(0).concat(b):b;if(d){d=d.map(function(i){return i.clone();});}for(f=0;f<d.length;f++){this.foundExtends=true;c=d[f];c.findSelfSelectors(n);c.ruleset=l;if(f===0){c.firstExtendOnThisSelectorPath=true;}this.allExtendsStack[this.allExtendsStack.length-1].push(c);}}this.contexts.push(l.selectors);},visitRulesetOut:function(b){if(!b.root){this.contexts.length=this.contexts.length-1;}},visitMedia:function(b,c){b.allExtends=[];this.allExtendsStack.push(b.allExtends);},visitMediaOut:function(b){this.allExtendsStack.length=this.allExtendsStack.length-1;},visitDirective:function(b,c){b.allExtends=[];this.allExtendsStack.push(b.allExtends);},visitDirectiveOut:function(b){this.allExtendsStack.length=this.allExtendsStack.length-1;}};a.processExtendsVisitor=function(){this._visitor=new a.visitor(this);};a.processExtendsVisitor.prototype={run:function(c){var b=new a.extendFinderVisitor();b.run(c);if(!b.foundExtends){return c;}c.allExtends=c.allExtends.concat(this.doExtendChaining(c.allExtends,c.allExtends));this.allExtendsStack=[c.allExtends];return this._visitor.visit(c);},doExtendChaining:function(f,g,j){var d,r,k,h=[],m,i=this,o,c,q,l;j=j||0;for(d=0;d<f.length;d++){for(r=0;r<g.length;r++){c=f[d];q=g[r];if(c.parent_ids.indexOf(q.object_id)>=0){continue;}o=[q.selfSelectors[0]];k=i.findMatch(c,o);if(k.length){c.selfSelectors.forEach(function(e){m=i.extendSelector(k,o,e);l=new (a.Extend)(q.selector,q.option,0);l.selfSelectors=m;m[m.length-1].extendList=[l];h.push(l);l.ruleset=q.ruleset;l.parent_ids=l.parent_ids.concat(q.parent_ids,c.parent_ids);if(q.firstExtendOnThisSelectorPath){l.firstExtendOnThisSelectorPath=true;q.ruleset.paths.push(m);}});}}}if(h.length){this.extendChainCount++;if(j>100){var n="{unable to calculate}";var p="{unable to calculate}";try{n=h[0].selfSelectors[0].toCSS();p=h[0].selector.toCSS();}catch(b){}throw {message:"extend circular reference detected. One of the circular extends is currently:"+n+":extend("+p+")"};}return h.concat(i.doExtendChaining(h,g,j+1));}else{return h;}},visitRule:function(b,c){c.visitDeeper=false;},visitMixinDefinition:function(b,c){c.visitDeeper=false;},visitSelector:function(b,c){c.visitDeeper=false;},visitRuleset:function(h,k){if(h.root){return;}var f,g,c,b=this.allExtendsStack[this.allExtendsStack.length-1],j=[],e=this,i;for(c=0;c<b.length;c++){for(g=0;g<h.paths.length;g++){i=h.paths[g];if(h.extendOnEveryPath){continue;}var d=i[i.length-1].extendList;if(d&&d.length){continue;}f=this.findMatch(b[c],i);if(f.length){b[c].selfSelectors.forEach(function(l){j.push(e.extendSelector(f,i,l));});}}}h.paths=h.paths.concat(j);},findMatch:function(b,h){var g,e,d,f,o,j,c=this,l=b.selector.elements,n=[],m,k=[];for(g=0;g<h.length;g++){e=h[g];for(d=0;d<e.elements.length;d++){f=e.elements[d];if(b.allowBefore||(g===0&&d===0)){n.push({pathIndex:g,index:d,matched:0,initialCombinator:f.combinator});}for(j=0;j<n.length;j++){m=n[j];o=f.combinator.value;if(o===""&&d===0){o=" ";}if(!c.isElementValuesEqual(l[m.matched].value,f.value)||(m.matched>0&&l[m.matched].combinator.value!==o)){m=null;}else{m.matched++;}if(m){m.finished=m.matched===l.length;if(m.finished&&(!b.allowAfter&&(d+1<e.elements.length||g+1<h.length))){m=null;}}if(m){if(m.finished){m.length=l.length;m.endPathIndex=g;m.endPathElementIndex=d+1;n.length=0;k.push(m);}}else{n.splice(j,1);j--;}}}}return k;},isElementValuesEqual:function(b,c){if(typeof b==="string"||typeof c==="string"){return b===c;}if(b instanceof a.Attribute){if(b.op!==c.op||b.key!==c.key){return false;}if(!b.value||!c.value){if(b.value||c.value){return false;}return true;}b=b.value.value||b.value;c=c.value.value||c.value;return b===c;}b=b.value;c=c.value;if(b instanceof a.Selector){if(!(c instanceof a.Selector)||b.elements.length!==c.elements.length){return false;}for(var d=0;d<b.elements.length;d++){if(b.elements[d].combinator.value!==c.elements[d].combinator.value){if(d!==0||(b.elements[d].combinator.value||" ")!==(c.elements[d].combinator.value||" ")){return false;}}if(!this.isElementValuesEqual(b.elements[d].value,c.elements[d].value)){return false;}}return true;}return false;},extendSelector:function(f,l,j){var c=0,b=0,i=[],g,k,d,e,h;for(g=0;g<f.length;g++){e=f[g];k=l[e.pathIndex];d=new a.Element(e.initialCombinator,j.elements[0].value,j.elements[0].index,j.elements[0].currentFileInfo);if(e.pathIndex>c&&b>0){i[i.length-1].elements=i[i.length-1].elements.concat(l[c].elements.slice(b));b=0;c++;}h=k.elements.slice(b,e.index).concat([d]).concat(j.elements.slice(1));if(c===e.pathIndex&&g>0){i[i.length-1].elements=i[i.length-1].elements.concat(h);}else{i=i.concat(l.slice(c,e.pathIndex));i.push(new a.Selector(h));}c=e.endPathIndex;b=e.endPathElementIndex;if(b>=l[c].elements.length){b=0;c++;}}if(c<l.length&&b>0){i[i.length-1].elements=i[i.length-1].elements.concat(l[c].elements.slice(b));c++;}i=i.concat(l.slice(c,l.length));return i;},visitRulesetOut:function(b){},visitMedia:function(b,d){var c=b.allExtends.concat(this.allExtendsStack[this.allExtendsStack.length-1]);c=c.concat(this.doExtendChaining(c,b.allExtends));this.allExtendsStack.push(c);},visitMediaOut:function(b){this.allExtendsStack.length=this.allExtendsStack.length-1;},visitDirective:function(b,d){var c=b.allExtends.concat(this.allExtendsStack[this.allExtendsStack.length-1]);c=c.concat(this.doExtendChaining(c,b.allExtends));this.allExtendsStack.push(c);},visitDirectiveOut:function(b){this.allExtendsStack.length=this.allExtendsStack.length-1;}};})(require("./tree"));