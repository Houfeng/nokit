/*csd*/var webpage=require("webpage");var server=require("webserver").create();var system=require("system");var fs=require("fs");var host;var port=8081;var listening=server.listen(port,function(b,c){var a=("test/"+b.url.slice(1)).replace(/[\\\/]/g,fs.separator);if(!fs.exists(a)||!fs.isFile(a)){c.statusCode=404;c.write("<html><head></head><body><h1>File Not Found</h1><h2>File:"+a+"</h2></body></html>");c.close();return;}c.statusCode=200;c.headers={"Cache":"no-cache","Content-Type":"text/html"};c.write(fs.read(a));c.close();});if(!listening){console.log("could not create web server listening on port "+port);phantom.exit();}function waitFor(testFx,onReady,timeOutMillis,timeOutErrorMessage){var maxtimeOutMillis=timeOutMillis?timeOutMillis:10001,start=new Date().getTime(),condition=false,interval=setInterval(function(){if((new Date().getTime()-start<maxtimeOutMillis)&&!condition){condition=(typeof(testFx)==="string"?eval(testFx):testFx());}else{if(!condition){console.log(timeOutErrorMessage||"'waitFor()' timeout");phantom.exit(1);}else{typeof(onReady)==="string"?eval(onReady):onReady();clearInterval(interval);}}},100);}function testPage(b){var a=webpage.create();a.open(b,function(c){if(c!=="success"){console.log("Unable to access network - "+c);phantom.exit();}else{waitFor(function(){return a.evaluate(function(){return document.body&&document.body.querySelector&&document.body.querySelector(".symbolSummary .pending")===null&&document.body.querySelector(".results")!==null;});},function(){a.onConsoleMessage=function(e){console.log(e);};var d=a.evaluate(function(){console.log("");console.log(document.body.querySelector(".description").innerText);var h=document.body.querySelectorAll(".results > #details > .specDetail.failed");if(h&&h.length>0){console.log("");console.log(h.length+" test(s) FAILED:");for(var g=0;g<h.length;++g){var f=h[g],e=f.querySelector(".description"),j=f.querySelector(".resultMessage.fail");console.log("");console.log(e.innerText);console.log(j.innerText);console.log("");}return 1;}else{console.log(document.body.querySelector(".alert > .passingAlert.bar").innerText);return 0;}});testFinished(d);},10000,"Test failed waiting for jasmine results on page: "+b);}});}function scanDirectory(b,c){var a=[];fs.list(b).forEach(function(d){if(d.match(c)){a.push(d);}});return a;}var totalTests=0,totalFailed=0,totalDone=0;function testFinished(a){if(a){totalFailed++;}totalDone++;if(totalDone===totalTests){phantom.exit(totalFailed>0?1:0);}}if(system.args.length!=2&&system.args[1]!="--no-tests"){var files=scanDirectory("test/browser/",/^test-runner-.+\.htm$/);totalTests=files.length;console.log("found "+files.length+" tests");files.forEach(function(a){testPage("http://localhost:8081/browser/"+a);});}