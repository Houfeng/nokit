/*csd*/(function(tree){tree.Ruleset=function(selectors,rules,strictImports){this.selectors=selectors;this.rules=rules;this._lookups={};this.strictImports=strictImports;};tree.Ruleset.prototype={type:"Ruleset",accept:function(visitor){if(this.paths){visitor.visitArray(this.paths,true);}else{if(this.selectors){this.selectors=visitor.visitArray(this.selectors);}}if(this.rules&&this.rules.length){this.rules=visitor.visitArray(this.rules);}},eval:function(env){var thisSelectors=this.selectors,selectors,selCnt,selector,i,defaultFunc=tree.defaultFunc,hasOnePassingSelector=false;if(thisSelectors&&(selCnt=thisSelectors.length)){selectors=[];defaultFunc.error({type:"Syntax",message:"it is currently only allowed in parametric mixin guards,"});for(i=0;i<selCnt;i++){selector=thisSelectors[i].eval(env);selectors.push(selector);if(selector.evaldCondition){hasOnePassingSelector=true;}}defaultFunc.reset();}else{hasOnePassingSelector=true;}var rules=this.rules?this.rules.slice(0):null,ruleset=new (tree.Ruleset)(selectors,rules,this.strictImports),rule,subRule;ruleset.originalRuleset=this;ruleset.root=this.root;ruleset.firstRoot=this.firstRoot;ruleset.allowImports=this.allowImports;if(this.debugInfo){ruleset.debugInfo=this.debugInfo;}if(!hasOnePassingSelector){rules.length=0;}var envFrames=env.frames;envFrames.unshift(ruleset);var envSelectors=env.selectors;if(!envSelectors){env.selectors=envSelectors=[];}envSelectors.unshift(this.selectors);if(ruleset.root||ruleset.allowImports||!ruleset.strictImports){ruleset.evalImports(env);}var rsRules=ruleset.rules,rsRuleCnt=rsRules?rsRules.length:0;for(i=0;i<rsRuleCnt;i++){if(rsRules[i] instanceof tree.mixin.Definition||rsRules[i] instanceof tree.DetachedRuleset){rsRules[i]=rsRules[i].eval(env);}}var mediaBlockCount=(env.mediaBlocks&&env.mediaBlocks.length)||0;for(i=0;i<rsRuleCnt;i++){if(rsRules[i] instanceof tree.mixin.Call){rules=rsRules[i].eval(env).filter(function(r){if((r instanceof tree.Rule)&&r.variable){return !(ruleset.variable(r.name));}return true;});rsRules.splice.apply(rsRules,[i,1].concat(rules));rsRuleCnt+=rules.length-1;i+=rules.length-1;ruleset.resetCache();}else{if(rsRules[i] instanceof tree.RulesetCall){rules=rsRules[i].eval(env).rules.filter(function(r){if((r instanceof tree.Rule)&&r.variable){return false;}return true;});rsRules.splice.apply(rsRules,[i,1].concat(rules));rsRuleCnt+=rules.length-1;i+=rules.length-1;ruleset.resetCache();}}}for(i=0;i<rsRules.length;i++){rule=rsRules[i];if(!(rule instanceof tree.mixin.Definition||rule instanceof tree.DetachedRuleset)){rsRules[i]=rule=rule.eval?rule.eval(env):rule;}}for(i=0;i<rsRules.length;i++){rule=rsRules[i];if(rule instanceof tree.Ruleset&&rule.selectors&&rule.selectors.length===1){if(rule.selectors[0].isJustParentSelector()){rsRules.splice(i--,1);for(var j=0;j<rule.rules.length;j++){subRule=rule.rules[j];if(!(subRule instanceof tree.Rule)||!subRule.variable){rsRules.splice(++i,0,subRule);}}}}}envFrames.shift();envSelectors.shift();if(env.mediaBlocks){for(i=mediaBlockCount;i<env.mediaBlocks.length;i++){env.mediaBlocks[i].bubbleSelectors(selectors);}}return ruleset;},evalImports:function(env){var rules=this.rules,i,importRules;if(!rules){return;}for(i=0;i<rules.length;i++){if(rules[i] instanceof tree.Import){importRules=rules[i].eval(env);if(importRules&&importRules.length){rules.splice.apply(rules,[i,1].concat(importRules));i+=importRules.length-1;}else{rules.splice(i,1,importRules);}this.resetCache();}}},makeImportant:function(){return new tree.Ruleset(this.selectors,this.rules.map(function(r){if(r.makeImportant){return r.makeImportant();}else{return r;}}),this.strictImports);},matchArgs:function(args){return !args||args.length===0;},matchCondition:function(args,env){var lastSelector=this.selectors[this.selectors.length-1];if(!lastSelector.evaldCondition){return false;}if(lastSelector.condition&&!lastSelector.condition.eval(new (tree.evalEnv)(env,env.frames))){return false;}return true;},resetCache:function(){this._rulesets=null;this._variables=null;this._lookups={};},variables:function(){if(!this._variables){this._variables=!this.rules?{}:this.rules.reduce(function(hash,r){if(r instanceof tree.Rule&&r.variable===true){hash[r.name]=r;}return hash;},{});}return this._variables;},variable:function(name){return this.variables()[name];},rulesets:function(){if(!this.rules){return null;}var _Ruleset=tree.Ruleset,_MixinDefinition=tree.mixin.Definition,filtRules=[],rules=this.rules,cnt=rules.length,i,rule;for(i=0;i<cnt;i++){rule=rules[i];if((rule instanceof _Ruleset)||(rule instanceof _MixinDefinition)){filtRules.push(rule);}}return filtRules;},prependRule:function(rule){var rules=this.rules;if(rules){rules.unshift(rule);}else{this.rules=[rule];}},find:function(selector,self){self=self||this;var rules=[],match,key=selector.toCSS();if(key in this._lookups){return this._lookups[key];}this.rulesets().forEach(function(rule){if(rule!==self){for(var j=0;j<rule.selectors.length;j++){match=selector.match(rule.selectors[j]);if(match){if(selector.elements.length>match){Array.prototype.push.apply(rules,rule.find(new (tree.Selector)(selector.elements.slice(match)),self));}else{rules.push(rule);}break;}}}});this._lookups[key]=rules;return rules;},genCSS:function(env,output){var i,j,ruleNodes=[],rulesetNodes=[],rulesetNodeCnt,debugInfo,rule,path;env.tabLevel=(env.tabLevel||0);if(!this.root){env.tabLevel++;}var tabRuleStr=env.compress?"":Array(env.tabLevel+1).join("  "),tabSetStr=env.compress?"":Array(env.tabLevel).join("  "),sep;for(i=0;i<this.rules.length;i++){rule=this.rules[i];if(rule.rules||(rule instanceof tree.Media)||rule instanceof tree.Directive||(this.root&&rule instanceof tree.Comment)){rulesetNodes.push(rule);}else{ruleNodes.push(rule);}}if(!this.root){debugInfo=tree.debugInfo(env,this,tabSetStr);if(debugInfo){output.add(debugInfo);output.add(tabSetStr);}var paths=this.paths,pathCnt=paths.length,pathSubCnt;sep=env.compress?",":(",\n"+tabSetStr);for(i=0;i<pathCnt;i++){path=paths[i];if(!(pathSubCnt=path.length)){continue;}if(i>0){output.add(sep);}env.firstSelector=true;path[0].genCSS(env,output);env.firstSelector=false;for(j=1;j<pathSubCnt;j++){path[j].genCSS(env,output);}}output.add((env.compress?"{":" {\n")+tabRuleStr);}for(i=0;i<ruleNodes.length;i++){rule=ruleNodes[i];if(i+1===ruleNodes.length&&(!this.root||rulesetNodes.length===0||this.firstRoot)){env.lastRule=true;}if(rule.genCSS){rule.genCSS(env,output);}else{if(rule.value){output.add(rule.value.toString());}}if(!env.lastRule){output.add(env.compress?"":("\n"+tabRuleStr));}else{env.lastRule=false;}}if(!this.root){output.add((env.compress?"}":"\n"+tabSetStr+"}"));env.tabLevel--;}sep=(env.compress?"":"\n")+(this.root?tabRuleStr:tabSetStr);rulesetNodeCnt=rulesetNodes.length;if(rulesetNodeCnt){if(ruleNodes.length&&sep){output.add(sep);}rulesetNodes[0].genCSS(env,output);for(i=1;i<rulesetNodeCnt;i++){if(sep){output.add(sep);}rulesetNodes[i].genCSS(env,output);}}if(!output.isEmpty()&&!env.compress&&this.firstRoot){output.add("\n");}},toCSS:tree.toCSS,markReferenced:function(){if(!this.selectors){return;}for(var s=0;s<this.selectors.length;s++){this.selectors[s].markReferenced();}},joinSelectors:function(paths,context,selectors){for(var s=0;s<selectors.length;s++){this.joinSelector(paths,context,selectors[s]);}},joinSelector:function(paths,context,selector){var i,j,k,hasParentSelector,newSelectors,el,sel,parentSel,newSelectorPath,afterParentJoin,newJoinedSelector,newJoinedSelectorEmpty,lastSelector,currentElements,selectorsMultiplied;for(i=0;i<selector.elements.length;i++){el=selector.elements[i];if(el.value==="&"){hasParentSelector=true;}}if(!hasParentSelector){if(context.length>0){for(i=0;i<context.length;i++){paths.push(context[i].concat(selector));}}else{paths.push([selector]);}return;}currentElements=[];newSelectors=[[]];for(i=0;i<selector.elements.length;i++){el=selector.elements[i];if(el.value!=="&"){currentElements.push(el);}else{selectorsMultiplied=[];if(currentElements.length>0){this.mergeElementsOnToSelectors(currentElements,newSelectors);}for(j=0;j<newSelectors.length;j++){sel=newSelectors[j];if(context.length===0){if(sel.length>0){sel[0].elements=sel[0].elements.slice(0);sel[0].elements.push(new (tree.Element)(el.combinator,"",el.index,el.currentFileInfo));}selectorsMultiplied.push(sel);}else{for(k=0;k<context.length;k++){parentSel=context[k];newSelectorPath=[];afterParentJoin=[];newJoinedSelectorEmpty=true;if(sel.length>0){newSelectorPath=sel.slice(0);lastSelector=newSelectorPath.pop();newJoinedSelector=selector.createDerived(lastSelector.elements.slice(0));newJoinedSelectorEmpty=false;}else{newJoinedSelector=selector.createDerived([]);}if(parentSel.length>1){afterParentJoin=afterParentJoin.concat(parentSel.slice(1));}if(parentSel.length>0){newJoinedSelectorEmpty=false;newJoinedSelector.elements.push(new (tree.Element)(el.combinator,parentSel[0].elements[0].value,el.index,el.currentFileInfo));newJoinedSelector.elements=newJoinedSelector.elements.concat(parentSel[0].elements.slice(1));}if(!newJoinedSelectorEmpty){newSelectorPath.push(newJoinedSelector);}newSelectorPath=newSelectorPath.concat(afterParentJoin);selectorsMultiplied.push(newSelectorPath);}}}newSelectors=selectorsMultiplied;currentElements=[];}}if(currentElements.length>0){this.mergeElementsOnToSelectors(currentElements,newSelectors);}for(i=0;i<newSelectors.length;i++){if(newSelectors[i].length>0){paths.push(newSelectors[i]);}}},mergeElementsOnToSelectors:function(elements,selectors){var i,sel;if(selectors.length===0){selectors.push([new (tree.Selector)(elements)]);return;}for(i=0;i<selectors.length;i++){sel=selectors[i];if(sel.length>0){sel[sel.length-1]=sel[sel.length-1].createDerived(sel[sel.length-1].elements.concat(elements));}else{sel.push(new (tree.Selector)(elements));}}}};})(require("../tree"));